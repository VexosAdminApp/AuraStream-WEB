<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AuraStream WEB - Industrial</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icon.png">
    <link rel="icon" type="image/png" href="/icon.png">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        :root {
            --bg: #0a0a0a;
            --card-bg: #141414;
            --accent: #00E676;
            --text-main: #ffffff;
            --text-dim: #888888;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .dashboard {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            max-width: 1200px;
            width: 100%;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid var(--accent);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            flex-grow: 0; /* Desativado o grow para respeitar o tamanho dinâmico */
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .tag-title {
            color: var(--text-dim);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tag-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--accent);
            white-space: nowrap;
        }

        .tag-unit {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-left: 5px;
        }

        @media (max-width: 600px) {
            .card { 
                width: 100% !important; 
                min-width: 100% !important;
                max-width: 100% !important;
            }
        }
    </style>
</head>
<body>
    <div id="dashboard" class="dashboard">
        <div style="color: #555; padding: 50px;">A aguardar dados do SCADA...</div>
    </div>

    <script>
        // Configuração Firebase (Preencher com os dados do seu projeto)
        const firebaseConfig = {
            apiKey: "",
            authDomain: "",
            databaseURL: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const dashboard = document.getElementById("dashboard");
        const currentPlantId = "SUA_PLANTA_ID"; // Ajustar para o ID real

        /**
         * Ajusta a largura do card dinamicamente.
         * Baseado no número de casas decimais e no comprimento do valor exibido.
         */
        function ajustarTamanhoCard(card, decimals, valorStr) {
            // Largura base inicial para nomes curtos e valores pequenos
            let baseWidth = 180;
            
            // Adicional por cada casa decimal (15px por dígito extra)
            let precisionExtra = (decimals || 0) * 15;
            
            // Adicional caso o número seja muito grande (ex: 1000000.00)
            let contentExtra = Math.max(0, valorStr.length - 4) * 12;
            
            let finalWidth = baseWidth + precisionExtra + contentExtra;
            
            // Aplica os limites de largura ao elemento
            card.style.minWidth = finalWidth + "px";
            card.style.maxWidth = (finalWidth + 120) + "px";
        }

        function iniciarMonitoramento() {
            if (!currentPlantId) return;

            db.ref('plants/' + currentPlantId + '/tags').on('value', (snapshot) => {
                const tags = snapshot.val();
                
                // SOLUÇÃO PONTO 1: Limpa o dashboard completamente antes de reconstruir.
                // Isso garante que variáveis removidas do Firebase desapareçam da tela na hora.
                dashboard.innerHTML = '';
                
                if (tags) {
                    for (const [tagName, tagData] of Object.entries(tags)) {
                        const card = document.createElement("div");
                        card.className = "card";
                        
                        let displayTitle = tagName.replace(/_/g, " ");
                        
                        // Tratamento de dados (suporta objeto completo ou valor simples)
                        let val = (typeof tagData === 'object' && tagData !== null) ? tagData.value : tagData;
                        let dec = (typeof tagData === 'object' && tagData !== null) ? (tagData.decimals ?? 2) : 2;
                        let unit = (typeof tagData === 'object' && tagData !== null) ? (tagData.unit || "") : "";
                        let color = (typeof tagData === 'object' && tagData !== null) ? (tagData.color || "#00E676") : "#00E676";
                        
                        // Formatação do valor numérico
                        let displayValue = (typeof val === 'number') ? val.toFixed(dec) : (val ?? "0");
                        
                        // Define a cor da borda baseada na tag
                        card.style.borderLeftColor = color;
                        
                        card.innerHTML = `
                            <div class="tag-title" title="${displayTitle}">${displayTitle}</div>
                            <div class="tag-value" style="color: ${color}">
                                ${displayValue}<span class="tag-unit">${unit}</span>
                            </div>
                        `;
                        
                        // SOLUÇÃO PONTO 2: Chama a função de ajuste dinâmico
                        ajustarTamanhoCard(card, dec, displayValue.toString());
                        
                        dashboard.appendChild(card);
                    }
                } else {
                    dashboard.innerHTML = '<div style="color: #555; padding: 50px;">Nenhuma variável ativa.</div>';
                }
            }, (error) => {
                console.error("Erro na leitura do Firebase:", error);
            });
        }

        // Inicializa o processo ao carregar a página
        window.onload = iniciarMonitoramento;
    </script>
</body>
</html>