<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuraStream - Painel WEB na Nuvem</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        /* (Pode colar aqui as mesmas cores e CSS que tínhamos no webserver.py) */
        body { background-color: #121212; color: white; font-family: sans-serif; text-align: center; }
        .dashboard-grid { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; padding: 20px;}
        .card { background: #1e1e1e; padding: 20px; border-radius: 10px; min-width: 250px; border-top: 4px solid #00E676; }
        .tag-value { font-size: 40px; color: #00BCD4; font-weight: bold; margin: 10px 0;}
    </style>
</head>
<body>
    <h1>AuraStream WEB</h1>
    <p style="color: #888;">Monitoramento Global via HiveMQ Cloud</p>
    
    <div class="dashboard-grid" id="dashboard">
        <div id="empty-msg">A aguardar dados da fábrica...</div>
    </div>

    <script>
        // CONFIGURAÇÕES DO HIVEMQ CLOUD
        // NOTA: Para WebSockets no HiveMQ, a porta é a 8884
        const brokerUrl = "wss://c09888474f2141f7b1fbcf2ad2560b73.s1.eu.hivemq.cloud:8884/mqtt";
        const options = {
            username: "vexosadmin",
            password: "#Fullaccessvexos01#",
            clientId: "web_client_" + Math.random().toString(16).substr(2, 8)
        };

        const client = mqtt.connect(brokerUrl, options);
        const dashboard = document.getElementById("dashboard");

        client.on("connect", () => {
            console.log("Ligado à Nuvem!");
            document.getElementById("empty-msg").style.display = "none";
            client.subscribe("aurastream/#");
        });

        client.on("message", (topic, message) => {
            try {
                const data = JSON.parse(message.toString());
                let id = topic.replace(/[^a-zA-Z0-9_-]/g, "_");
                let card = document.getElementById(id);

                if (!card) {
                    card = document.createElement("div");
                    card.className = "card";
                    card.id = id;
                    dashboard.appendChild(card);
                }

                let value = data.error ? "ERRO" : parseFloat(data.value).toFixed(data.decimals || 2);
                let color = data.error ? "#ff4444" : "#00E676";
                card.style.borderTopColor = color;

                card.innerHTML = `
                    <div style="color: #aaa;">${data.device} - ${data.tag}</div>
                    <div class="tag-value">${value} <span style="font-size: 16px; color: white;">${data.unit || ""}</span></div>
                    <div style="font-size: 11px; color: #666;">Última leitura: ${data.timestamp}</div>
                `;
            } catch (e) { console.error("Erro no pacote:", e); }
        });
    </script>
</body>
</html>